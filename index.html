<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Tracking Scanner</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <div class="restricted-screen">
            <h1>RESTRICTED ACCESS</h1>
            <p>Enter Crew PIN to continue</p>
            <p class="pin-help">Use your Crew Login ID from the database</p>
            <div class="pin-input-container">
                <input 
                    type="password" 
                    id="pinInput" 
                    class="pin-input" 
                    placeholder="Enter PIN"
                    maxlength="20"
                    autocomplete="off"
                />
            </div>
            <button class="btn btn-primary" onclick="handlePinSubmit()">ENTER</button>
            <div id="errorMessage"></div>
        </div>
    </div>

    <script>
        console.log('Script starting...');
        
        // Auto-focus PIN input when page loads
        (function() {
            function focusInput() {
                const pinInput = document.getElementById('pinInput');
                if (pinInput) {
                    pinInput.focus();
                    pinInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            handlePinSubmit();
                        }
                    });
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', focusInput);
            } else {
                setTimeout(focusInput, 100);
            }
        })();
        
        // ============================================
        // API CONFIGURATION
        // ============================================
        const API_CONFIG = {
            // TODO: Paste your n8n Production URL here
            WEBHOOK_URL: 'https://michaelcarey.app.n8n.cloud/webhook/8a5874ca-1694-48fa-a908-cde99a3a9af8',
            API_KEY: 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN' 
        };
        
        // ============================================
        // WEBHOOK API CALLER
        // ============================================
        async function callWebhook(action, payload = {}) {
            if (!API_CONFIG.WEBHOOK_URL || API_CONFIG.WEBHOOK_URL.includes('PASTE_YOUR')) {
                throw new Error('Webhook URL not configured. Please add your n8n webhook URL.');
            }
            
            try {
                console.log('Calling webhook with action:', action, 'payload:', payload);
                
                const response = await fetch(API_CONFIG.WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'cors', // Explicitly request CORS
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_CONFIG.API_KEY,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action, // This is what the n8n Switch node looks for
                        ...payload
                    })
                });
                
                console.log('Response status:', response.status, response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                console.log('Response content-type:', contentType);
                
                // Try to parse as JSON, but handle text responses
                let data;
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.warn('Response is not JSON, got text:', text);
                    // Try to parse as JSON anyway
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        // If it's not JSON, return the text
                        data = text;
                    }
                }
                
                console.log('Parsed response data:', data);
                return data;
            } catch (error) {
                console.error('Webhook call failed:', error);
                
                // Check if it's a CORS error
                if (error.message && error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    const isFileProtocol = window.location.protocol === 'file:';
                    if (isFileProtocol) {
                        throw new Error('CORS Error: Please run this file through a local web server (not file://). Use: python -m http.server 8000 or npx serve');
                    } else {
                        throw new Error('CORS Error: n8n webhook needs to allow CORS. Add CORS headers in your n8n workflow or configure webhook CORS settings.');
                    }
                }
                
                throw error;
            }
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let currentCrew = null;
        let currentTool = null;
        let myTools = [];

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            console.log('Initializing app...');
            
            // Check for existing session
            const session = localStorage.getItem('crew_session');
            if (session) {
                try {
                    currentCrew = JSON.parse(session);
                    loadApp();
                } catch (e) {
                    console.error('Error parsing session:', e);
                    localStorage.removeItem('crew_session');
                    loadApp(); // Still call loadApp to handle tool_id if present
                }
            } else {
                // No session - check if there's a tool_id in URL
                loadApp();
            }
            
            // Check webhook configuration warning
            if (!API_CONFIG.WEBHOOK_URL || API_CONFIG.WEBHOOK_URL.includes('PASTE_YOUR')) {
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.innerHTML = `
                        <div class="error" style="margin-top: 1rem;">
                            <p>⚠️ Webhook URL not configured in index.html</p>
                        </div>
                    `;
                }
            }
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function authenticate(pin) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) errorDiv.innerHTML = '<div class="loading">Authenticating...</div>';
            
            try {
                // FIXED: Action name changed to 'verify_crew' to match n8n
                const response = await callWebhook('verify_crew', {
                    login_id: pin.trim(),
                    // Sending pin as 'pin' too just in case n8n expects it that way
                    pin: pin.trim() 
                });
                
                console.log('Full webhook response:', response);
                console.log('Response type:', typeof response);
                console.log('Response keys:', response ? Object.keys(response) : 'null');
                
                // Handle different response formats
                // Check if response is a string (like "workflow started")
                if (typeof response === 'string') {
                    console.error('n8n returned string instead of JSON:', response);
                    showError('n8n workflow is not configured to wait for completion. Please configure your n8n webhook to "Wait for Workflow to Finish" and return JSON.');
                    return;
                }
                
                // Check if response has the expected structure
                if (response.success && response.crew) {
                    console.log('Authentication successful!', response.crew);
                    currentCrew = response.crew;
                    localStorage.setItem('crew_session', JSON.stringify(currentCrew));
                    
                    // Check if there's a pending tool_id from QR code scan
                    const pendingToolId = sessionStorage.getItem('pending_tool_id');
                    if (pendingToolId) {
                        sessionStorage.removeItem('pending_tool_id');
                        // Redirect to tool
                        window.location.href = `?tool_id=${pendingToolId}`;
                    } else {
                        await loadApp();
                    }
                } else if (response.crew) {
                    // Handle case where success might be missing but crew exists
                    console.log('Authentication successful (no success flag)!', response.crew);
                    currentCrew = response.crew;
                    localStorage.setItem('crew_session', JSON.stringify(currentCrew));
                    
                    // Check if there's a pending tool_id from QR code scan
                    const pendingToolId = sessionStorage.getItem('pending_tool_id');
                    if (pendingToolId) {
                        sessionStorage.removeItem('pending_tool_id');
                        // Redirect to tool
                        window.location.href = `?tool_id=${pendingToolId}`;
                    } else {
                        await loadApp();
                    }
                } else {
                    console.warn('Unexpected response format:', response);
                    showError(response.message || response.error || 'Invalid PIN or unexpected response format. Check console for details.');
                }
            } catch (error) {
                console.error('Auth error:', error);
                console.error('Error details:', error.message, error.stack);
                showError('Authentication failed: ' + (error.message || 'Check connection and n8n workflow configuration.'));
            }
        }

        function logout() {
            localStorage.removeItem('crew_session');
            currentCrew = null;
            currentTool = null;
            myTools = [];
            showRestrictedScreen();
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function showRestrictedScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="restricted-screen">
                    <div class="login-header">
                        <svg class="login-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h1>TSW Tracking System</h1>
                        <p class="login-subheadline">Authorized Access</p>
                    </div>
                    <div class="login-card">
                        <p class="pin-help">Enter your assigned Crew ID</p>
                        <div class="pin-input-container">
                            <input type="password" id="pinInput" class="pin-input" placeholder="Enter Crew ID" maxlength="20" autocomplete="off" />
                        </div>
                        <button class="btn btn-primary" onclick="handlePinSubmit()">VERIFY IDENTITY</button>
                        <div id="errorMessage"></div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                const pinInput = document.getElementById('pinInput');
                if (pinInput) {
                    pinInput.focus();
                    pinInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handlePinSubmit();
                    });
                }
            }, 100);
        }

        function showPropertyOfTSW(toolId) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="restricted-screen">
                    <div style="margin-bottom: 2rem;">
                        <h1 style="font-size: 1.75rem; color: #f59e0b; margin-bottom: 1rem; font-weight: 800;">Property of TSW</h1>
                        <p style="color: #cbd5e1; font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.6;">
                            This tool is tracked by TSW Construction
                        </p>
                        <div style="background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(245, 158, 11, 0.3);">
                            <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Tool Manager Contact</p>
                            <p style="color: #f59e0b; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                                <a href="tel:+13172002112" style="color: #f59e0b; text-decoration: none; transition: all 0.2s;">+1 (317) 200-2112</a>
                            </p>
                            <p style="color: #64748b; font-size: 0.875rem;">Call to report found tool</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="goToLogin()">Go to Login</button>
                </div>
            `;
            
            // Store tool_id so we can redirect after login
            if (toolId) {
                sessionStorage.setItem('pending_tool_id', toolId);
            }
        }

        function goToLogin() {
            // Clear the tool_id from URL and show login
            window.history.pushState({}, '', window.location.pathname);
            showRestrictedScreen();
        }

        async function loadApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const toolId = urlParams.get('tool_id');

            if (toolId) {
                // Check if user is logged in
                if (!currentCrew) {
                    // Not logged in - show Property of TSW screen
                    showPropertyOfTSW(toolId);
                } else {
                    // Logged in - show tool details
                    await loadToolDetail(toolId);
                }
            } else {
                // No tool_id - show dashboard or login
                if (currentCrew) {
                    showDashboard();
                } else {
                    showRestrictedScreen();
                }
            }
        }

        async function showDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="dashboard">
                    <div class="welcome-header">
                        <h1>Welcome, ${currentCrew.name}</h1>
                        <p>TSW Tracking System</p>
                    </div>
                    <button class="btn btn-primary" onclick="loadMyTools()">View My Tools</button>
                    <div id="content"></div>
                </div>
                <button class="logout-btn" onclick="logout()">LOGOUT</button>
            `;
        }

        async function loadMyTools() {
            try {
                showLoading('Loading your tools...');

                // FIXED: Action name changed to 'get_crew_tools' to match n8n
                const response = await callWebhook('get_crew_tools', {
                    crew_id: currentCrew.login_id
                });

                if (response.success) {
                    // Handle if n8n returns data in 'tools' or 'data' property
                    myTools = response.tools || response.data || [];
                    renderMyTools();
                } else {
                    throw new Error(response.message || 'Failed to load tools');
                }
            } catch (error) {
                console.error('Error loading tools:', error);
                showError('Failed to load tools.');
            }
        }

        function renderMyTools() {
            const content = document.getElementById('content');
            if (myTools.length === 0) {
                content.innerHTML = `<div class="success" style="margin-top: 1rem;"><p>You have no tools checked out.</p></div>`;
                return;
            }
            let html = `<div class="tools-list"><h2 style="color: #f59e0b; margin: 1.5rem 0 1rem 0;">My Tools (${myTools.length})</h2>`;
            myTools.forEach(tool => {
                const name = tool.tool_name || tool.name || 'Unknown Tool';
                const id = tool.tool_id || tool.id;
                html += `
                    <div class="tool-card" onclick="loadToolDetail('${id}')">
                        <div class="tool-card-header">
                            <div class="tool-card-name">${escapeHtml(name)}</div>
                            <span class="tool-status status-checked_out">CHECKED OUT</span>
                        </div>
                    </div>`;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        async function loadToolDetail(toolId) {
            try {
                showLoading('Loading tool details...');

                // FIXED: Action name changed to 'search_tool' to match n8n
                const response = await callWebhook('search_tool', {
                    tool_id: toolId
                });

                // n8n might return the tool directly or wrapped in data
                if (response) {
                    currentTool = response.tool || response; // Flexible handling
                    renderToolDetail();
                } else {
                    throw new Error('Tool not found');
                }
            } catch (error) {
                console.error('Error loading tool:', error);
                showError('Tool not found.');
            }
        }

        function renderToolDetail() {
            if (!currentTool) return;

            const app = document.getElementById('app');
            const status = currentTool.status || 'unknown';
            const statusClass = status === 'checked_out' ? 'status-checked_out' : (status === 'in_shop' ? 'status-in_shop' : 'status-other');
            
            // Logic to determine if I have the tool
            const isCheckedOut = status === 'checked_out';
            const isMyTool = (currentTool.current_holder || currentTool.current_crew_id) == currentCrew.login_id;

            let actionButtons = '';
            if (isCheckedOut && isMyTool) {
                actionButtons = `<button class="btn btn-success" onclick="handleCheckIn()">Check In</button>`;
            } else if (!isCheckedOut) {
                actionButtons = `<button class="btn btn-primary" onclick="handleCheckOut()">Check Out</button>`;
            } else {
                actionButtons = `<div class="error"><p>Checked out by: ${escapeHtml(currentTool.current_holder || 'Unknown')}</p></div>`;
            }

            app.innerHTML = `
                <div class="dashboard">
                    <button class="btn btn-secondary back-btn" onclick="goToDashboard()">← Back to Dashboard</button>
                    <div class="tool-detail">
                        <div class="tool-name">${escapeHtml(currentTool.tool_name || currentTool.name)}</div>
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <span class="tool-status ${statusClass}">${escapeHtml(status)}</span>
                        </div>
                        ${currentTool.image ? `<img src="${escapeHtml(currentTool.image)}" class="tool-photo" onerror="this.style.display='none'">` : ''}
                        <div class="action-buttons">${actionButtons}</div>
                    </div>
                    <div id="message"></div>
                </div>
                <button class="logout-btn" onclick="logout()">LOGOUT</button>
            `;
        }

        // ============================================
        // ACTIONS
        // ============================================
        async function handleCheckOut() {
            try {
                showLoading('Processing checkout...');
                
                // FIXED: Action name changed to 'checkout' to match n8n
                const response = await callWebhook('checkout', {
                    tool_id: currentTool.tool_id || currentTool.id,
                    crew_id: currentCrew.login_id
                });

                if (response.status === 'success') {
                    showSuccess('Tool checked out!');
                    // Reload tool to see update
                    await loadToolDetail(currentTool.tool_id || currentTool.id);
                } else {
                    throw new Error(response.message || 'Failed');
                }
            } catch (error) {
                showError('Failed to check out.');
            }
        }

        async function handleCheckIn() {
            try {
                showLoading('Processing check-in...');
                
                // FIXED: Action name changed to 'checkin' to match n8n
                const response = await callWebhook('checkin', {
                    tool_id: currentTool.tool_id || currentTool.id,
                    crew_id: currentCrew.login_id
                });

                if (response.status === 'success') {
                    showSuccess('Tool checked in!');
                    await loadToolDetail(currentTool.tool_id || currentTool.id);
                } else {
                    throw new Error(response.message || 'Failed');
                }
            } catch (error) {
                showError('Failed to check in.');
            }
        }

        // ============================================
        // HELPERS & STARTUP
        // ============================================
        function handlePinSubmit() {
            const pin = document.getElementById('pinInput').value.trim();
            if (!pin) { showError('Please enter a PIN.'); return; }
            authenticate(pin);
        }

        function goToDashboard() {
            window.history.pushState({}, '', window.location.pathname);
            showDashboard();
        }

        function showLoading(msg) {
            const el = document.getElementById('content') || document.getElementById('app');
            if (el) el.innerHTML = `<div class="loading">${escapeHtml(msg)}</div>`;
        }

        function showError(msg) {
            const el = document.getElementById('errorMessage') || document.getElementById('message') || document.getElementById('content');
            if (el) el.innerHTML = `<div class="error">${escapeHtml(msg)}</div>`;
        }

        function showSuccess(msg) {
            const el = document.getElementById('message') || document.getElementById('content');
            if (el) {
                el.innerHTML = `<div class="success">${escapeHtml(msg)}</div>`;
                setTimeout(() => el.innerHTML = '', 3000);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.addEventListener('popstate', loadApp);
        
        // Start App
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
