<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextGen AI - Asset Control</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="glass-card">
                <div class="brand-header">
                    <div class="login-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                    </div>
                    <h1 class="brand-title">TSW Tracking System</h1>
                    <p class="brand-subtitle">POWERED BY NEXTGEN AI</p>
                </div>
                <div class="login-form">
                    <label for="crewPin" class="input-label">Enter Crew PIN to continue</label>
                    <input 
                        type="text" 
                        id="crewPin" 
                        class="input-field" 
                        placeholder="Enter Crew ID"
                        autocomplete="off"
                    >
                    <button id="loginBtn" class="btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" class="screen">
        <header class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">ASSET CONTROL</h1>
                <div class="header-actions">
                    <span class="crew-name" id="crewNameDisplay"></span>
                    <button id="logoutBtn" class="btn-secondary">LOGOUT</button>
                </div>
            </div>
        </header>

        <main class="dashboard-main">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="tab-btn active" data-tab="scan">SCAN TOOL</button>
                <button class="tab-btn" data-tab="mytools">MY TOOLS</button>
            </div>

            <!-- Scan Tool Tab -->
            <div id="scanTab" class="tab-content active">
                <div class="scan-container">
                    <div class="scan-header">
                        <h2>Tool Scanner</h2>
                        <p>Scan a tool ID or enter manually</p>
                    </div>
                    <div class="scan-input-group">
                        <input 
                            type="text" 
                            id="toolScanInput" 
                            class="scan-input" 
                            placeholder="Enter or scan Tool ID"
                            autocomplete="off"
                        >
                        <button id="scanBtn" class="btn-primary">SCAN</button>
                    </div>
                    <div id="toolResult" class="tool-result"></div>
                </div>
            </div>

            <!-- My Tools Tab -->
            <div id="mytoolsTab" class="tab-content">
                <div class="tools-container">
                    <div class="tools-header">
                        <h2>My Checked Out Tools</h2>
                        <button id="refreshToolsBtn" class="btn-secondary">REFRESH</button>
                    </div>
                    <div id="toolsList" class="tools-list"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            WEBHOOK_URL: 'https://michaelcarey.app.n8n.cloud/webhook/8a5874ca-1694-48fa-a908-cde99a3a9af8',
            API_KEY: 'sk_foreman_aK19zJb7pQ3xR4sV9zLq8mN'
        };

        // Master Webhook Function
        async function callWebhook(action, payload) {
            try {
                const response = await fetch(API_CONFIG.WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_CONFIG.API_KEY
                    },
                    body: JSON.stringify({
                        action: action,
                        ...payload
                    })
                });

                // Try to parse response even if status is not OK to see error message
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    data = await response.text();
                }

                if (!response.ok) {
                    console.error('HTTP error response:', {
                        status: response.status,
                        statusText: response.statusText,
                        data: data
                    });
                    
                    if (response.status === 403) {
                        throw new Error(`Authentication failed (403). Please check your API key in the code matches the one configured in n8n.`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}, message: ${JSON.stringify(data)}`);
                }
                
                console.log('Raw webhook response:', JSON.stringify(data, null, 2));
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                // Check if workflow is running async (n8n cloud sometimes does this)
                if (data && data.message && data.message.includes('Workflow was started')) {
                    console.warn('⚠️ n8n workflow is running asynchronously. Please check:');
                    console.warn('1. Is the workflow ACTIVE in n8n?');
                    console.warn('2. Does the "Respond to Webhook" node exist and is it the last node in the verify_crew path?');
                    console.warn('3. Try testing the workflow directly in n8n to verify it returns { "valid": true }');
                }
                
                // Handle string responses that need parsing
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        // If it's not valid JSON, return as-is
                        return data;
                    }
                }
                
                // Handle array responses from n8n
                if (Array.isArray(data) && data.length > 0) {
                    return data[0];
                }
                return data;
            } catch (error) {
                console.error('Webhook call failed:', error);
                throw error;
            }
        }

        // Utility Functions
        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function getCrewData() {
            const crewData = localStorage.getItem('crew');
            return crewData ? JSON.parse(crewData) : null;
        }

        function saveCrewData(crew) {
            localStorage.setItem('crew', JSON.stringify(crew));
        }

        function clearCrewData() {
            localStorage.removeItem('crew');
        }

        // Login Handler
        async function handleLogin() {
            const pinInput = document.getElementById('crewPin');
            const pin = pinInput.value.trim();

            if (!pin) {
                showToast('Please enter a Crew ID', 'error');
                return;
            }

            try {
                const result = await callWebhook('verify_crew', { pin: pin });
                
                // Debug logging
                console.log('Full login response:', JSON.stringify(result, null, 2));
                
                // Check if n8n returned async message - this shouldn't happen but handle it gracefully
                if (result && result.message && result.message.includes('Workflow was started')) {
                    console.error('⚠️ n8n workflow is still running asynchronously. This is an n8n configuration issue.');
                    console.error('Please check:');
                    console.error('1. The workflow is ACTIVE in n8n');
                    console.error('2. The webhook Response Mode is set to "Using \'Respond to Webhook\' Node"');
                    console.error('3. The "Respond to Webhook" node is the last node in the verify_crew path');
                    console.error('4. Try deactivating and reactivating the workflow');
                    showToast('Workflow configuration issue. Please check n8n settings.', 'error');
                    return;
                }
                
                // Handle array response like [{ "valid": true }]
                let responseData = result;
                if (Array.isArray(result) && result.length > 0) {
                    responseData = result[0];
                }
                
                console.log('Processed response data:', JSON.stringify(responseData, null, 2));
                
                // Check if valid exists and is truthy
                const isValid = responseData && (
                    responseData.valid === true || 
                    responseData.valid === 'true' || 
                    responseData.valid === 'True' || 
                    responseData.valid === 1
                );
                
                console.log('Is valid?', isValid, 'responseData.valid:', responseData?.valid);
                
                if (isValid) {
                    // Save crew data - n8n currently only returns {valid: true}
                    // So we create crew object from the PIN
                    const crewData = responseData.crew || { login_id: pin, name: pin };
                    saveCrewData(crewData);
                    
                    // Display crew name
                    const displayName = crewData.name || crewData.login_id || pin;
                    document.getElementById('crewNameDisplay').textContent = displayName;
                    
                    showScreen('dashboardScreen');
                    
                    // Ensure scan tab is active (check in/check out page)
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.querySelector('[data-tab="scan"]').classList.add('active');
                    document.getElementById('scanTab').classList.add('active');
                    
                    pinInput.value = '';
                } else {
                    console.log('Login failed - responseData:', JSON.stringify(responseData, null, 2));
                    showToast('Invalid Crew ID. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed. Please check your connection.', 'error');
            }
        }

        // Scan Tool Handler
        async function handleScanTool(toolIdFromUrl = null) {
            const toolInput = document.getElementById('toolScanInput');
            const toolId = toolIdFromUrl || toolInput.value.trim();

            if (!toolId) {
                showToast('Please enter a Tool ID', 'error');
                return;
            }

            // Check if user is logged in
            const crew = getCrewData();
            if (!crew) {
                // Show TSW return message when not logged in
                const resultDiv = document.getElementById('toolResult');
                resultDiv.innerHTML = `
                    <div class="tsw-return-message">
                        <h3>Please Return to TSW</h3>
                        <p>This tool must be returned through your authorized system.</p>
                        <p class="phone-number">Call: <a href="tel:+13175089502">(317) 508-9502</a></p>
                    </div>
                `;
                // Clear URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            const resultDiv = document.getElementById('toolResult');
            resultDiv.innerHTML = '<div class="loading">Scanning tool...</div>';

            try {
                const result = await callWebhook('search_tool', { tool_id: toolId });
                
                // Handle array response from n8n and map field names
                let tool = null;
                if (Array.isArray(result) && result.length > 0) {
                    const toolData = result[0];
                    // Map n8n fields to expected format
                    tool = {
                        id: toolData.tool_id,
                        name: toolData.tool_name,
                        status: toolData.current_holder || toolData.status,
                        condition: toolData.condition,
                        photo_url: toolData.photo_location
                    };
                } else if (result.tool) {
                    tool = result.tool;
                } else if (result.tool_id || result.tool_name) {
                    // Handle direct object response with n8n field names
                    tool = {
                        id: result.tool_id,
                        name: result.tool_name,
                        status: result.current_holder || result.status,
                        condition: result.condition,
                        photo_url: result.photo_location
                    };
                }
                
                if (tool) {
                    const status = (tool.status || '').toLowerCase();
                    let statusClass = 'other';
                    if (status === 'checked_out') statusClass = 'checked_out';
                    else if (status === 'available' || status === 'in_shop' || status === 'shop') statusClass = 'in_shop';
                    
                    resultDiv.innerHTML = `
                        <div class="tool-card">
                            <div class="tool-image-container">
                                ${tool.photo_url ? 
                                    `<img src="${tool.photo_url}" alt="${tool.name}" class="tool-image">` :
                                    '<div class="tool-image-placeholder">No Image</div>'
                                }
                            </div>
                            <div class="tool-info">
                                <h3 class="tool-name">${tool.name || 'Unknown Tool'}</h3>
                                <div class="tool-status ${statusClass}">
                                    ${tool.status || 'Unknown'}
                                </div>
                            </div>
                            <div class="tool-actions">
                                ${status === 'available' || status === 'in_shop' || status === 'shop' ? 
                                    `<button class="btn-action checkout" onclick="handleCheckout('${tool.id || toolId}')">
                                        CHECK OUT
                                    </button>` :
                                    status === 'checked_out' ?
                                    `<button class="btn-action checkin" onclick="handleCheckin('${tool.id || toolId}')">
                                        CHECK IN
                                    </button>` :
                                    ''
                                }
                            </div>
                        </div>
                    `;
                    // Clear the input and URL parameter
                    toolInput.value = '';
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    resultDiv.innerHTML = '<div class="error-message">Tool not found</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error-message">Failed to scan tool. Please try again.</div>';
                showToast('Failed to scan tool', 'error');
            }
        }

        // Checkout Handler
        async function handleCheckout(toolId) {
            const crew = getCrewData();
            if (!crew) {
                showToast('Please login again', 'error');
                showScreen('loginScreen');
                return;
            }

            try {
                const result = await callWebhook('checkout', { 
                    tool_id: toolId, 
                    crew_id: crew.login_id 
                });
                
                showToast('Tool checked out successfully', 'success');
                // Refresh the tool data
                setTimeout(() => handleScanTool(), 500);
            } catch (error) {
                showToast('Checkout failed. Please try again.', 'error');
            }
        }

        // Checkin Handler
        async function handleCheckin(toolId) {
            const crew = getCrewData();
            if (!crew) {
                showToast('Please login again', 'error');
                showScreen('loginScreen');
                return;
            }

            try {
                const result = await callWebhook('checkin', { 
                    tool_id: toolId, 
                    crew_id: crew.login_id 
                });
                
                showToast('Tool checked in successfully', 'success');
                // Refresh the tool data
                setTimeout(() => handleScanTool(), 500);
            } catch (error) {
                showToast('Check-in failed. Please try again.', 'error');
            }
        }

        // Load My Tools
        async function loadMyTools() {
            const crew = getCrewData();
            if (!crew) {
                showToast('Please login again', 'error');
                showScreen('loginScreen');
                return;
            }

            const toolsList = document.getElementById('toolsList');
            toolsList.innerHTML = '<div class="loading">Loading your tools...</div>';

            try {
                const result = await callWebhook('get_crew_tools', { crew_id: crew.login_id });
                
                // Handle array or object response
                const tools = result.tools || (Array.isArray(result) ? result : []);
                
                if (tools && tools.length > 0) {
                    toolsList.innerHTML = tools.map(tool => `
                        <div class="tool-item">
                            <div class="tool-item-image">
                                ${tool.photo_url ? 
                                    `<img src="${tool.photo_url}" alt="${tool.name || 'Tool'}">` :
                                    '<div class="tool-item-placeholder">No Image</div>'
                                }
                            </div>
                            <div class="tool-item-info">
                                <h4>${tool.name || 'Unknown Tool'}</h4>
                                <p>ID: ${tool.id || tool.tool_id || 'N/A'}</p>
                                <span class="tool-item-status checked_out">Checked Out</span>
                            </div>
                            <div class="tool-actions">
                                <button class="btn-action checkin" onclick="handleCheckin('${tool.id || tool.tool_id}')">
                                    CHECK IN
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    toolsList.innerHTML = '<div class="empty-state">No tools checked out</div>';
                }
            } catch (error) {
                toolsList.innerHTML = '<div class="error-message">Failed to load tools. Please try again.</div>';
                showToast('Failed to load tools', 'error');
            }
        }

        // Logout Handler
        function handleLogout() {
            clearCrewData();
            showScreen('loginScreen');
            document.getElementById('toolResult').innerHTML = '';
            document.getElementById('toolsList').innerHTML = '';
            document.getElementById('toolScanInput').value = '';
        }

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                if (tab === 'mytools') {
                    document.getElementById('mytoolsTab').classList.add('active');
                    // Automatically load tools when switching to My Tools tab
                    loadMyTools();
                } else {
                    document.getElementById('scanTab').classList.add('active');
                }
            });
        });

        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('crewPin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        document.getElementById('scanBtn').addEventListener('click', handleScanTool);
        document.getElementById('toolScanInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleScanTool();
        });

        document.getElementById('refreshToolsBtn').addEventListener('click', loadMyTools);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // Make functions globally available for onclick handlers
        window.handleCheckout = handleCheckout;
        window.handleCheckin = handleCheckin;

        // Check if user is already logged in and handle URL parameters (for QR code scanning)
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const toolId = urlParams.get('tool_id') || urlParams.get('id');
            
            const crew = getCrewData();
            if (crew) {
                document.getElementById('crewNameDisplay').textContent = 
                    crew.name || crew.login_id || 'Crew Member';
                showScreen('dashboardScreen');
                
                // If there's a tool_id in URL and user is logged in, scan it automatically
                if (toolId) {
                    setTimeout(() => handleScanTool(toolId), 100);
                }
            } else {
                // User not logged in
                if (toolId) {
                    // If there's a tool_id in URL but user is NOT logged in, show TSW message
                    showScreen('dashboardScreen');
                    setTimeout(() => {
                        const resultDiv = document.getElementById('toolResult');
                        resultDiv.innerHTML = `
                            <div class="tsw-return-message">
                                <h3>Please Return to TSW</h3>
                                <p>This tool must be returned through your authorized system.</p>
                                <p class="phone-number">Call: <a href="tel:+13175089502">(317) 508-9502</a></p>
                            </div>
                        `;
                        // Clear URL parameter
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 100);
                } else {
                    showScreen('loginScreen');
                }
            }
        });
    </script>
</body>
</html>

